global
    log stdout format raw local0 info
    maxconn 4096
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000

frontend http-in
    bind *:80
    mode http

    # Define ACLs for each service
    acl is_jellyfin hdr(host) -i jellyfin.tharmas.local
    acl is_sonarr hdr(host) -i sonarr.tharmas.local
    acl is_radarr hdr(host) -i radarr.tharmas.local
    acl is_lidarr hdr(host) -i lidarr.tharmas.local
    acl is_ombi hdr(host) -i ombi.tharmas.local
    acl is_sabnzbd hdr(host) -i sabnzbd.tharmas.local
    acl is_main hdr(host) -i tharmas.local

    # Route to backends based on ACLs
    use_backend jellyfin if is_jellyfin
    use_backend sonarr if is_sonarr
    use_backend radarr if is_radarr
    use_backend lidarr if is_lidarr
    use_backend ombi if is_ombi
    use_backend sabnzbd if is_sabnzbd
    use_backend main if is_main

backend jellyfin
    server jellyfin jellyfin:8096 check

backend sonarr
    server sonarr sonarr:8989 check

backend radarr
    server radarr radarr:7878 check

backend lidarr
    server lidarr lidarr:8686 check

backend ombi
    server ombi ombi:3579 check

backend sabnzbd
    server sabnzbd sabnzbd:8080 check

backend main
    server static nginx:80 check